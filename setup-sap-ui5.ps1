# setup-sap-ui5.ps1 - PowerShell –≤–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ SAP UI5 –¥–ª—è LAB01
# –í–µ—Ä—Å–∏—è: 2.0

param(
    [switch]$Force,
    [switch]$SkipBackup
)

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
$Colors = @{
    Red = "Red"
    Green = "Green"
    Yellow = "Yellow"
    Blue = "Blue"
}

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
function Write-LogInfo {
    param([string]$Message)
    Write-Host "[INFO] $Message" -ForegroundColor Green
}

function Write-LogWarn {
    param([string]$Message)
    Write-Host "[WARN] $Message" -ForegroundColor Yellow
}

function Write-LogError {
    param([string]$Message)
    Write-Host "[ERROR] $Message" -ForegroundColor Red
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
function Test-Dependencies {
    Write-LogInfo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    $nodeExists = Get-Command node -ErrorAction SilentlyContinue
    if (-not $nodeExists) {
        Write-LogError "Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Node.js –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–∞."
        exit 1
    }
    
    $npmExists = Get-Command npm -ErrorAction SilentlyContinue
    if (-not $npmExists) {
        Write-LogError "npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
        exit 1
    }
    
    Write-LogInfo "‚úì –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
function Backup-Existing {
    if ((Test-Path "public/js/sap-ui5") -or (Test-Path "public/index-sap.html")) {
        Write-LogWarn "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ SAP UI5"
        
        if (-not $SkipBackup) {
            $response = Read-Host "–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é? (y/n)"
            if ($response -eq "y" -or $response -eq "Y") {
                $backupDir = "backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
                New-Item -ItemType Directory -Path $backupDir -Force | Out-Null
                
                if (Test-Path "public/js/sap-ui5") {
                    Copy-Item -Path "public/js/sap-ui5" -Destination "$backupDir/" -Recurse -Force
                }
                if (Test-Path "public/index-sap.html") {
                    Copy-Item -Path "public/index-sap.html" -Destination "$backupDir/" -Force
                }
                
                Write-LogInfo "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ $backupDir"
            }
        }
    }
}

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è VAPID –∫–ª—é—á–µ–π
function Get-VapidKeys {
    Write-LogInfo "üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è VAPID –∫–ª—é—á–µ–π..."
    
    $webPushExists = Get-Command npx -ErrorAction SilentlyContinue
    if ($webPushExists) {
        try {
            $vapidOutput = npx web-push generate-vapid-keys --json 2>$null
            if ($vapidOutput) {
                $vapidJson = $vapidOutput | ConvertFrom-Json
                return @{
                    PublicKey = $vapidJson.publicKey
                    PrivateKey = $vapidJson.privateKey
                }
            }
        } catch {
            Write-LogWarn "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ VAPID –∫–ª—é—á–µ–π: $_"
        }
    }
    
    Write-LogWarn "web-push –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏"
    return @{
        PublicKey = "BOLuMnBs0R9VSoKE2iKEhtxjbwYGjkRB9GrI8XILrV2WAMF7yml4jy1poojaYKGSqr0wxHzMxuxDA5jJxwsJ-dM"
        PrivateKey = "your-private-key"
    }
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
function Install-SapUI5 {
    Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Blue
    Write-Host "‚ïë    üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SAP UI5 –¥–ª—è LAB01     ‚ïë" -ForegroundColor Blue
    Write-Host "‚ïë         –í–µ—Ä—Å–∏—è 2.0 Enhanced           ‚ïë" -ForegroundColor Blue
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Blue
    Write-Host ""

    Test-Dependencies
    Backup-Existing

    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    Write-LogInfo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫..."
    $directories = @(
        "public/css",
        "public/js/sap-ui5/controller",
        "public/js/sap-ui5/view",
        "public/js/sap-ui5/fragment",
        "public/js/sap-ui5/model",
        "public/js/sap-ui5/formatter",
        "public/js/sap-ui5/util",
        "public/i18n",
        "public/localService/mockdata",
        "public/test/unit",
        "public/test/integration",
        "public/resources/img"
    )

    foreach ($dir in $directories) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
    }

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è VAPID –∫–ª—é—á–µ–π
    $vapidKeys = Get-VapidKeys

    # –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    Write-LogInfo "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."

    # –°–æ–∑–¥–∞–Ω–∏–µ config.js
    $configContent = "// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è LAB01 SAP UI5
window.LAB01Config = {
    version: `"2.0.0`",
    apiUrl: window.location.origin + `"/api`",
    wsUrl: `"ws://`" + window.location.host + `"/ws`",
    vapidPublicKey: `"$($vapidKeys.PublicKey)`",
    features: {
        notifications: true,
        offline: true,
        darkMode: true,
        export: true
    },
    themes: [
        { key: `"sap_fiori_3`", text: `"SAP Fiori 3`" },
        { key: `"sap_fiori_3_dark`", text: `"SAP Fiori 3 Dark`" },
        { key: `"sap_horizon`", text: `"SAP Horizon`" },
        { key: `"sap_horizon_dark`", text: `"SAP Horizon Dark`" },
        { key: `"sap_belize`", text: `"SAP Belize`" },
        { key: `"sap_belize_plus`", text: `"SAP Belize Plus`" }
    ],
    defaultSettings: {
        theme: `"sap_fiori_3`",
        compactMode: false,
        language: `"ru`",
        refreshInterval: 30000,
        notificationsEnabled: true
    }
};"
    Set-Content -Path "public/js/sap-ui5/config.js" -Value $configContent -Encoding UTF8

    Write-LogInfo "üèóÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ Component.js..."
    # –°–æ–∑–¥–∞–Ω–∏–µ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ Component.js –¥–ª—è PowerShell
    $componentContent = 'sap.ui.define([
    "sap/ui/core/UIComponent",
    "sap/ui/Device",
    "sap/ui/model/json/JSONModel"
], function (UIComponent, Device, JSONModel) {
    "use strict";

    return UIComponent.extend("lab01.Component", {
        metadata: {
            manifest: "json"
        },

        init: function () {
            UIComponent.prototype.init.apply(this, arguments);
            this._createDeviceModel();
            this.getRouter().initialize();
        },

        _createDeviceModel: function() {
            var oDeviceModel = new JSONModel(Device);
            oDeviceModel.setDefaultBindingMode("OneWay");
            this.setModel(oDeviceModel, "device");
        }
    });
});'
    Set-Content -Path "public/js/sap-ui5/Component.js" -Value $componentContent -Encoding UTF8

    # –°–æ–∑–¥–∞–Ω–∏–µ manifest.json
    Write-LogInfo "üìÑ –°–æ–∑–¥–∞–Ω–∏–µ manifest.json..."
    $manifestContent = '{
    "_version": "1.32.0",
    "sap.app": {
        "id": "lab01",
        "type": "application",
        "applicationVersion": {
            "version": "2.0.0"
        },
        "title": "LAB01 - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏ –ù–ö"
    },
    "sap.ui": {
        "technology": "UI5",
        "deviceTypes": {
            "desktop": true,
            "tablet": true,
            "phone": true
        }
    },
    "sap.ui5": {
        "dependencies": {
            "minUI5Version": "1.100.0",
            "libs": {
                "sap.m": {},
                "sap.ui.core": {},
                "sap.ui.layout": {},
                "sap.f": {}
            }
        },
        "models": {
            "": {
                "type": "sap.ui.model.json.JSONModel"
            }
        }
    }
}'
    Set-Content -Path "public/js/sap-ui5/manifest.json" -Value $manifestContent -Encoding UTF8

    # –°–æ–∑–¥–∞–Ω–∏–µ index-sap.html
    Write-LogInfo "üåê –°–æ–∑–¥–∞–Ω–∏–µ index-sap.html..."
    $indexSapLines = @(
        "<!DOCTYPE html>",
        "<html>",
        "<head>",
        "    <meta charset='utf-8'>",
        "    <meta name='viewport' content='width=device-width, initial-scale=1.0'>",
        "    <title>LAB01 - SAP UI5</title>",
        "    <script id='sap-ui-bootstrap'",
        "        src='https://ui5.sap.com/1.120.0/resources/sap-ui-core.js'",
        "        data-sap-ui-theme='sap_fiori_3'",
        "        data-sap-ui-libs='sap.m,sap.ui.core,sap.f'",
        "        data-sap-ui-compatVersion='edge'",
        "        data-sap-ui-async='true'",
        "        data-sap-ui-oninit='module:lab01/index'",
        "        data-sap-ui-resourceroots='{",
        '            "lab01": "./js/sap-ui5/"',
        "        }'>",
        "    </script>",
        "    <script src='js/sap-ui5/config.js'></script>",
        "</head>",
        "<body class='sapUiBody'>",
        "    <div id='content'></div>",
        "</body>",
        "</html>"
    )
    $indexSapContent = $indexSapLines -join "`n"
    Set-Content -Path "public/index-sap.html" -Value $indexSapContent -Encoding UTF8

    # –°–æ–∑–¥–∞–Ω–∏–µ .env.example
    Write-LogInfo "üîê –°–æ–∑–¥–∞–Ω–∏–µ .env.example..."
    $envContent = "# Server Configuration
PORT=3000
NODE_ENV=development

# Email Configuration
EMAIL_ENABLED=true
EMAIL_HOST=smtp.yandex.ru
EMAIL_PORT=465
EMAIL_SECURE=true
EMAIL_USER=your-email@yandex.ru
EMAIL_PASS=your-password
EMAIL_FROM=LAB01 System your-email@yandex.ru

# Push Notifications
PUSH_ENABLED=true
VAPID_SUBJECT=mailto:admin@company.ru
VAPID_PUBLIC_KEY=$($vapidKeys.PublicKey)
VAPID_PRIVATE_KEY=$($vapidKeys.PrivateKey)

# Application URL
APP_URL=http://localhost:3000"

    Set-Content -Path ".env.example" -Value $envContent -Encoding UTF8

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ VAPID –∫–ª—é—á–µ–π
    $vapidKeysContent = "VAPID Keys Generated:
====================
Public Key: $($vapidKeys.PublicKey)
Private Key: $($vapidKeys.PrivateKey)

Add these to your .env file!"

    Set-Content -Path "VAPID_KEYS.txt" -Value $vapidKeysContent -Encoding UTF8

    Write-Host ""
    Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
    Write-Host "‚ïë                   ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!                      ‚ïë" -ForegroundColor Green
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
    Write-Host ""
    Write-Host "üìã –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏:" -ForegroundColor Blue
    Write-Host "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ .env.example –≤ .env –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ"
    Write-Host "2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: npm start"
    Write-Host "3. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000/index-sap.html"
    Write-Host ""
    Write-Host "üìñ VAPID –∫–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ VAPID_KEYS.txt"
    Write-LogInfo "–î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ http://localhost:3000"
}

# –ó–∞–ø—É—Å–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
Install-SapUI5 